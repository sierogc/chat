<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>iPhone Chat â€” Demo automatica</title>
  <style>
    /* ---------- VARIABILI BASE ---------- */
    :root {
      --bg: #ffffff;
      --bubble-in: #e5e5ea;
      --bubble-out: #34c759;
      --text-in: #000000;
      --text-out: #ffffff;
      --font: "SF Pro Text", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    /* ---------- STRUTTURA BASE ---------- */
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: var(--font);
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    /* ---------- SCHERMATA TELEFONO ---------- */
    #screen {
      width: 360px;
      max-width: 100%;
      height: 780px;
      border-radius: 28px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
      overflow: hidden;
      background: linear-gradient(#f8f8f8, #fff);
      position: relative;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    /* ---------- STATUS BAR ---------- */
    .status-bar {
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 14px;
      color: #666;
      font-size: 14px;
    }

    /* ---------- CHAT ---------- */
    .chat {
      flex: 1;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow-y: auto;
      scroll-behavior: smooth;
    }

    /* ---------- MESSAGGI ---------- */
    .message {
      max-width: 78%;
      padding: 10px 14px;
      border-radius: 18px;
      font-size: 15px;
      line-height: 1.3;
      word-break: break-word;
      box-shadow: 0 1px 0 rgba(0,0,0,0.03);
    }

    .message.in {
      align-self: flex-start;
      background: var(--bubble-in);
      color: var(--text-in);
      border-top-left-radius: 4px;
    }

    .message.out {
      align-self: flex-end;
      background: var(--bubble-out);
      color: var(--text-out);
      border-top-right-radius: 4px;
    }

    /* ---------- ANIMAZIONE PUNTINI ---------- */
    .typing-dots {
      display: inline-block;
      width: 32px;
      height: 18px;
      border-radius: 10px;
      background: transparent;
      vertical-align: middle;
    }

    .typing-dots span {
      display: inline-block;
      width: 6px;
      height: 6px;
      margin: 0 2px;
      border-radius: 50%;
      background: rgba(0,0,0,0.25);
      animation: dot 1s infinite;
    }

    .typing-dots span:nth-child(2) { animation-delay: .15s; }
    .typing-dots span:nth-child(3) { animation-delay: .3s; }

    @keyframes dot {
      0% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
      100% { transform: translateY(0); }
    }

    /* ---------- BOLLA INPUT INFERIORE ---------- */
    .input-bubble {
      height: 50px;
      display: flex;
      align-items: center;
      padding: 0 16px;
      border-top: 1px solid #ddd;
      background: #f5f5f7;
      color: #666;
      font-size: 14px;
      font-style: italic;
    }
  </style>
</head>

<body>
  <main id="screen" tabindex="0" aria-label="Schermata chat simulata">
    <header class="status-bar">
      <div class="time">9:41</div>
      <div class="icons">ðŸ”‹ 100%</div>
    </header>

    <section id="chat" class="chat"></section>

    <div id="input-bubble" class="input-bubble">...</div>
  </main>

  <script>
  (() => {
    const chat = document.getElementById('chat');
    const screen = document.getElementById('screen');
    const inputBubble = document.getElementById('input-bubble');
    let playing = true;

    /* ---------- MESSAGGI DELLA CONVERSAZIONE ---------- */
    const messages = [
      { who: 'in', text: "Hey, ci sei?", delay: 800 },
      { who: 'out', text: "SÃ¬, dimmi.", delay: 1200 },
      { who: 'in', text: "Ho appena visto qualcosa di incredibile oggi...", delay: 900 },
      { who: 'out', text: "Raccontami!", delay: 1500 },
      { who: 'in', text: "Ãˆ una lunga storia â€” te la dico quando hai 2 minuti.", delay: 1000 },
      { who: 'out', text: "Perfetto, aspetto.", delay: 1300 },
      { who: 'in', text: "Ok, ora.", delay: 1000 },
      { who: 'in', text: "Comincia cosÃ¬: l'ombra si avvicina e poi...", delay: 800 },
      { who: 'out', text: "Noo, non mi spoilerare cosÃ¬!", delay: 1100 },
      { who: 'in', text: "Ok ok, la prossima volta porto foto.", delay: 900 }
    ];

    /* ---------- AUDIO SINTETICO ---------- */
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioCtx();

    function playTypeClick() {
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'square';
      o.frequency.setValueAtTime(1200, audioCtx.currentTime);
      g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.08, audioCtx.currentTime + 0.001);
      g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.08);
      o.connect(g); g.connect(audioCtx.destination);
      o.start(); o.stop(audioCtx.currentTime + 0.09);
    }

    function playReceiveTone() {
      const now = audioCtx.currentTime;
      const o1 = audioCtx.createOscillator();
      const g1 = audioCtx.createGain();
      o1.type = 'sine'; o1.frequency.setValueAtTime(900, now);
      g1.gain.setValueAtTime(0.001, now);
      g1.gain.exponentialRampToValueAtTime(0.08, now + 0.01);
      g1.gain.exponentialRampToValueAtTime(0.001, now + 0.14);
      o1.connect(g1); g1.connect(audioCtx.destination);
      o1.start(now); o1.stop(now + 0.16);
    }

    /* ---------- DIGITAZIONE REALISTICA ---------- */
    function typeInto(element, text, onChar, onComplete) {
      let i = 0;
      function step() {
        if (!playing) return setTimeout(step, 200);

        if (Math.random() < 0.02 && i > 2) {
          // Simula backspace
          element.textContent = element.textContent.slice(0, -1);
          i--;
          return setTimeout(step, 150);
        }

        if (i < text.length) {
          element.textContent += text[i++];
          onChar && onChar();
          const delay = 40 + Math.random() * 80;
          setTimeout(step, delay);
          chat.scrollTop = chat.scrollHeight;
        } else {
          onComplete && onComplete();
        }
      }
      step();
    }

    /* ---------- SIMULAZIONE ---------- */
    async function playSequence() {
      for (const msg of messages) {
        await waitWhilePaused(msg.delay);

        // Se messaggio in arrivo, mostra puntini
        if (msg.who === 'in') {
          const typing = createTypingBubble('in');
          chat.appendChild(typing);
          chat.scrollTop = chat.scrollHeight;

          // Durata proporzionale alla lunghezza del testo
          const typingTime = 400 + msg.text.length * 60 + Math.random() * 300;
          await waitWhilePaused(typingTime);

          chat.removeChild(typing);
        } else {
          // Mostra il testo nella bolla inferiore mentre viene scritto
          inputBubble.textContent = '';
          await new Promise(resolve => {
            typeInto(inputBubble, msg.text, playTypeClick, () => resolve());
          });
          await waitWhilePaused(300);
          inputBubble.textContent = '...';
        }

        // Crea la bolla effettiva
        const bubble = document.createElement('div');
        bubble.className = `message ${msg.who}`;
        chat.appendChild(bubble);
        chat.scrollTop = chat.scrollHeight;

        await new Promise(resolve => {
          typeInto(bubble, msg.text, playTypeClick, () => {
            if (msg.who === 'in') playReceiveTone();
            resolve();
          });
        });

        await waitWhilePaused(450 + Math.random() * 700);
      }
    }

    /* ---------- CREAZIONE BOLLA CON PUNTINI ---------- */
    function createTypingBubble(who) {
      const el = document.createElement('div');
      el.className = `message ${who}`;
      const dots = document.createElement('span');
      dots.className = 'typing-dots';
      dots.innerHTML = '<span></span><span></span><span></span>';
      el.appendChild(dots);
      return el;
    }

    /* ---------- UTILITY ATTESA ---------- */
    function waitWhilePaused(ms) {
      return new Promise(res => {
        const start = performance.now();
        function tick() {
          if (!playing) return setTimeout(tick, 150);
          const elapsed = performance.now() - start;
          if (elapsed >= ms) return res();
          setTimeout(tick, Math.min(120, ms - elapsed));
        }
        tick();
      });
    }

    /* ---------- PLAY / PAUSA ---------- */
    function togglePlay() {
      playing = !playing;
      if (playing && audioCtx.state === 'suspended') audioCtx.resume();
      screen.style.opacity = playing ? '1' : '0.7';
    }

    screen.addEventListener('click', togglePlay);
    playSequence();
  })();
  </script>
</body>
</html>
